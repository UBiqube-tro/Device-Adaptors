#!/bin/bash

#set -x

PROG=$(basename $0)

usage() {
	echo "usage: $PROG <install|uninstall> <device adaptor directory>"
	echo
	echo "install or un-install MSA device adaptors"
}

main() {
	cmd=$1
	shift
	case $cmd in
		""|-h|--help)
			usage
			;;
		-i|install)
			da_install "$1"
			;;
		-u|uninstall)
			da_uninstall "$1"
			;;
		*)
			fatal "unknown command: $1"
			;;
	esac
}

da_install() {
	DA_DIR=$1
	[ -d "$DA_DIR" ] || \
		fatal "device-adaptor dir not found: $DA_DIR"

	read_properties_files
	check_sms_router_conf
	:;
}

da_uninstall() {
	:;
}

update_files() {

# ----- COURTESY OF NEC

DEBUG=$1
NOW=$(date +"%Y%m%d%H%M")

	update_manufacturers_properties
	update_models_properties
	update_sdExtendedInfo_properties
	update_manageLinks_properties
	update_ses_properties
	update_repository_properties
	do_debug
}


update_manufacturers_properties() {
	target_file="/opt/ubi-jentreprise/resources/templates/conf/device/manufacturers.properties"
grep "^70000," $target_file > /dev/null
if [ $? -ne 0 ]; then
  echo "  Modifying $target_file"
  /bin/cp -p $target_file $target_file.org.necNfa.$NOW

	fixup_no_newline_at_eof $target_file

  echo '70000,"NEC",1' >> $target_file
fi
}

update_models_properties() {

	target_file="/opt/ubi-jentreprise/resources/templates/conf/device/models.properties"
grep "^17111602," $target_file > /dev/null
if [ $? -ne 0 ]; then
  echo "  Modifying $target_file"
  /bin/cp -p $target_file $target_file.org.necNfa.$NOW

	fixup_no_newline_at_eof $target_file

  echo '17111602,70000,"NEC NFA","H",0,0,0,0,0,1,0,0,0,0,0,SR,0,0' >> $target_file
fi
}

update_sdExtendedInfo_properties() {

	target_file="/opt/ses/properties/specifics/server_ALL/sdExtendedInfo.properties"
if [ ! -f "$target_file" ]; then
  echo "  Copying $target_file"
  /bin/cp -p /opt/ses/templates/server_ALL/sdExtendedInfo.properties $target_file
fi

grep "necNfa" $target_file > /dev/null
if [ $? -ne 0 ]; then
  echo "  Modifying $target_file"
  /bin/cp -p $target_file $target_file.org.necNfa.$NOW

	fixup_no_newline_at_eof $target_file

  echo 'sdExtendedInfo.router.70000-17111602 = necNfa' >> $target_file
  echo 'sdExtendedInfo.jspType.70000-17111602 = necNfa' >> $target_file
fi
}

update_manageLinks_properties() {

	target_file="/opt/ses/properties/specifics/server_ALL/manageLinks.properties"
if [ ! -f "$target_file" ]; then
  echo "  Copying $target_file"
  /bin/cp -p /opt/ses/templates/server_ALL/manageLinks.properties $target_file
fi

grep "necNfa" $target_file > /dev/null
if [ $? -ne 0 ]; then
  echo "  Modifying $target_file"
  /bin/cp -p $target_file $target_file.org.necNfa.$NOW

  /bin/cat $target_file \
    | sed 's/^\(siteLink.initialProv.models.*\)/\1 necNfa/' \
    | sed 's/^\(siteLink.detailedReports.models.*\)/\1 necNfa/' \
    | sed 's/^\(siteLink.displayLogs.models.*\)/\1 necNfa/' \
    | sed 's/^\(device.wizard.authentication.window.models.*\)/\1 necNfa/' \
    | sed 's/^\(device.cisco.license.manager.models.*\)/\1 necNfa/' \
    | sed 's/^\(device.wizard.managecertificate.models.*\)/\1 necNfa/' \
    | sed 's/^\(device.wizard.specific.rules.and.commands.models.*\)/\1 necNfa/' \
    | sed 's/^\(device.wizard.check.non.empty.credentials.models.*\)/\1 necNfa/' \
    | sed 's/^\(configobjectconsole.supported.models.*\)/\1 necNfa/' \
    > /tmp/msa.$$
  /bin/cp -p /tmp/msa.$$ $target_file
  /bin/rm -f /tmp/msa.$$
fi
}

update_ses_properties() {

	target_file="/opt/ses/properties/specifics/server_ALL/ses.properties"
if [ ! -f "$target_file" ]; then
  echo "  Copying $target_file"
  /bin/cp -p /opt/ses/templates/server_ALL/ses.properties $target_file
fi

grep "^soc.device.supported.nec" $target_file > /dev/null
if [ $? -ne 0 ]; then
  echo "  Modifying $target_file"
  /bin/cp -p $target_file $target_file.org.necNfa.$NOW
  echo 'soc.device.supported.nec=1' >> $target_file
fi
}

update_repository_properties() {

	target_file="/opt/ses/properties/specifics/server_ALL/repository.properties"
if [ ! -f "$target_file" ]; then
  echo "  Copying $target_file"
  /bin/cp -p /opt/ses/templates/server_ALL/repository.properties $target_file
fi

CP_DONE=0
grep "^repository.manufacturer.* NEC.*" $target_file > /dev/null
if [ $? -ne 0 ]; then
  echo "  Modifying(1) $target_file"
  /bin/cp -p $target_file $target_file.org.necNfa.$NOW
  CP_DONE=1
  /bin/cat $target_file \
    | sed 's/^\(repository.manufacturer.*\)/\1 NEC/' \
    > /tmp/msa.$$
  /bin/cp -p /tmp/msa.$$ $target_file
  /bin/rm -f /tmp/msa.$$
fi

grep "^repository.access.nec=" $target_file > /dev/null
if [ $? -ne 0 ]; then
  echo "  Modifying(2) $target_file"
  if [ $CP_DONE -eq 0 ]; then
    /bin/cp -p $target_file $target_file.org.necNfa.$NOW
    CP_DONE=1
  fi
  echo 'repository.model.nec=70000-17072801 70000-17111601 70000-17111602' >> $target_file
  echo 'repository.access.nec=|Configuration|Firmware|CommandDefinition|Datafiles|Reports|License|Orchestration|Process|' >> $target_file
fi
}

do_debug() {
## for debug
if [ "$DEBUG" == "debug" ]; then
  echo
  diff -u /opt/ubi-jentreprise/resources/templates/conf/device/manufacturers.properties.org.necNfa.$NOW /opt/ubi-jentreprise/resources/templates/conf/device/manufacturers.properties
  diff -u /opt/ubi-jentreprise/resources/templates/conf/device/models.properties.org.necNfa.$NOW /opt/ubi-jentreprise/resources/templates/conf/device/models.properties
  diff -u /opt/ses/properties/specifics/server_ALL/sdExtendedInfo.properties.org.necNfa.$NOW /opt/ses/properties/specifics/server_ALL/sdExtendedInfo.properties
  diff -u /opt/ses/properties/specifics/server_ALL/manageLinks.properties.org.necNfa.$NOW /opt/ses/properties/specifics/server_ALL/manageLinks.properties
  diff -u /opt/ses/properties/specifics/server_ALL/ses.properties.org.necNfa.$NOW /opt/ses/properties/specifics/server_ALL/ses.properties
  diff -u /opt/ses/properties/specifics/server_ALL/repository.properties.org.necNfa.$NOW /opt/ses/properties/specifics/server_ALL/repository.properties
fi

# ----- END COURTESY OF NEC
}

fixup_no_newline_at_eof() {
  ## ファイル末尾に改行がない場合の対処
  /bin/cat "$1" | awk '{print}' > /tmp/msa.$$
  /bin/cp -p /tmp/msa.$$ "$1"
  /bin/rm -f /tmp/msa.$$
}

read_properties_files() {
	device_properties="conf/device.properties"
	[ -f "$DA_DIR/$device_properties" ] || \
		fatal "file not found: $device_properties"

	MAN_ID=$(read_property "$device_properties" "manufacturer.id")
	MOD_ID=$(read_property "$device_properties" "model.id")
	MOD_NAME=$(read_property "$device_properties" "model.name")
	MAN_NAME=$(read_property "$device_properties" "manufacturer.name")
}

check_sms_router_conf() {
	sms_router_conf="conf/sms_router.conf"
	[ -f "$DA_DIR/$sms_router_conf" ] || \
		fatal "file not found: $sms_router_conf"

	spec=$(cat $DA_DIR/$sms_router_conf | egrep '^model' | awk '{print $2}')
	man_id=$(cut -d : -f 1 <<< "$spec")
	mod_id=$(cut -d : -f 2 <<< "$spec")

	[ "$man_id" = "$MAN_ID" ] || \
		fatal "inconsistent definition: man_id=$man_id MAN_ID=$MAN_ID"
	[ "$mod_id" = "$MOD_ID" ] || \
		fatal "inconsistent definition: mod_id=$mod_id MOD_ID=$MOD_ID"
}

read_property() {
	file=$1
	prop=$2
	cat $DA_DIR/$file | egrep "^$prop" | cut -d = -f 2 | tr -d ' '
}

fatal() {
	echo $* >&2
	exit 1
}


main "$@"
